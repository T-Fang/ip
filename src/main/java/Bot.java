import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import java.util.Scanner;

// The bot that handles inputs and give responses
public class Bot {
    private static final String divider = "\t____________________________________________________________\n";

    Scanner sc = new Scanner(System.in);
    LinkedList<Task> taskList = new LinkedList<>();

    //start the bot
    public void start() {
        try {
            connectWithStorage();
        } catch (DukeException e) {
            giveResponse(e.getMessage());
        }

        String greeting = "Hello! I'm Duke\n" +
                "\t What can I do for you?";
        giveResponse(greeting);


        String input = getInput();
        while (!input.equals("bye")) {
            try {
                if (input.equals("list")) {
                    displayList();
                } else if (input.startsWith("done")) {
                    completeTask(input);
                } else if (input.startsWith("delete")){
                    deleteTask(input);
                } else {
                    addTask(input);
                }
                Storage.saveList(taskList);
            } catch (DukeException e) {
                giveResponse(e.getMessage());
            }
            input = getInput();
        }
        giveResponse("Bye. Hope to see you again soon!");
    }

    private void connectWithStorage() throws DukeException{
        try {
            taskList = Storage.readList();
        } catch (NoDataException e) {
            throw new DukeException("No data found! You can try to add a few tasks!");
        } catch (IOException e) {
            throw new DukeException("I cannot access the data file!");
        }
    }

    //print out the response
    private void giveResponse(String response) {
        System.out.println(divider + "\t " + response + "\n" + divider);
    }

    //get the next input
    private String getInput() {
        return sc.nextLine();
    }

    // add a task with a given command
    private void addTask(String command) throws DukeException {
        Task newTask;
        if (command.startsWith("todo")) {
            if (command.length() <= 5) {
                throw new DukeException("The description of a todo cannot be empty.");
            }
            newTask = new Todo(command.substring(5));
        } else if (command.startsWith("deadline")) {
            if (command.length() <= 9) {
                throw new DukeException("The description of a deadline cannot be empty.");
            }
            String description = command.substring(9);
            int index = description.indexOf("/by");
            if (index == -1 || description.length() - index <= 4 ) {
                throw new DukeException("I don't know when the deadline is");
            }
            String by = description.substring(index + 4);
            description = description.substring(0, index - 1);
            newTask = new Deadline(description, by);
        } else if (command.startsWith("event")) {
            if (command.length() <= 6) {
                throw new DukeException("The description of a event cannot be empty.");
            }
            String description = command.substring(6);
            int index = description.indexOf("/at");
            if (index == -1 || description.length() - index <= 4 ) {
                throw new DukeException("I don't know when the event take place");
            }
            String at = description.substring(index + 4);
            description = description.substring(0, index - 1);
            newTask = new Event(description, at);
        } else {
            throw new DukeException();
        }
        taskList.add(newTask);
        giveResponse("Got it. I've added this task:\n       " +
                newTask +
                "\n\t Now you have " + taskList.size() +
                " task" + (taskList.size() > 1 ? "s" : "") + " in the list.");
    }

    // mark a task as completed
    private void completeTask(String command) throws DukeException {
        if (command.length() <= 5) {
            throw new DukeException("I don't know which task should be marked as completed.");
        }
        int index;
        try {
            index = Integer.parseInt(command.substring(5)) - 1;
        } catch (NumberFormatException e) {
            throw new DukeException("The task index should be a number.");
        }

        if (index < 0) {
            throw new DukeException("The task index should be a positive number.");
        }
        Task task = taskList.get(index);
        task.markAsDone();
        giveResponse("Nice! I've marked this task as done:\n       " + task);
    }

    // delete a task
    private void deleteTask(String command) throws DukeException {
        if (command.length() <= 7) {
            throw new DukeException("I don't know which task should be deleted.");
        }
        int index;
        try {
            index = Integer.parseInt(command.substring(7)) - 1;
        } catch (NumberFormatException e) {
            throw new DukeException("The task index should be a number.");
        }

        if (index < 0) {
            throw new DukeException("The task index should be a positive number.");
        }
        Task task = taskList.get(index);
        taskList.remove(index);
        giveResponse(" Noted. I've removed this task:\n       " +
                task +
                "\n\t Now you have " + taskList.size() +
                " task" + (taskList.size() > 1 ? "s" : "") + " in the list.");
    }

    // display the task list
    private void displayList(){
        String list = "Here are the tasks in your list:\n";
        for (int i = 1; i <= taskList.size(); i++) {
            list += "\t " + i + ". " + taskList.get(i - 1) + "\n";
        }

        //remove the extra "\n"
        if(!list.isEmpty()) {
            list = list.substring(0, list.length() - 1);
        }

        giveResponse(list);
    }
}

